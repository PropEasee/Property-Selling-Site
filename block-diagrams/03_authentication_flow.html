<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropEase - Authentication Flow</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 20px;
            background: #f5f5f5;
            margin: 0;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2563eb;
            margin-bottom: 30px;
        }
        svg {
            width: 100%;
            height: auto;
        }
        .box {
            fill: #fff;
            stroke: #2563eb;
            stroke-width: 2;
            rx: 8;
        }
        .frontend { fill: #dbeafe; }
        .backend { fill: #fef3c7; }
        .success { fill: #d1fae5; }
        .error { fill: #fee2e2; }
        .arrow { stroke: #6b7280; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
        .arrow-success { stroke: #059669; stroke-width: 3; marker-end: url(#arrowhead-success); }
        .arrow-error { stroke: #dc2626; stroke-width: 2; marker-end: url(#arrowhead-error); }
        text { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 13px; }
        .title { font-weight: bold; font-size: 15px; }
        .code { font-family: 'Courier New', monospace; font-size: 11px; fill: #374151; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê PropEase - JWT Authentication & Authorization Flow</h1>
        <svg viewBox="0 0 1600 1400" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#6b7280" />
                </marker>
                <marker id="arrowhead-success" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#059669" />
                </marker>
                <marker id="arrowhead-error" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#dc2626" />
                </marker>
            </defs>
            
            <!-- Title -->
            <text x="800" y="30" text-anchor="middle" style="font-size: 22px; font-weight: bold; fill: #1e40af;">
                USER REGISTRATION & LOGIN FLOW
            </text>
            
            <!-- ========== REGISTRATION FLOW ========== -->
            <text x="300" y="70" text-anchor="middle" style="font-size: 18px; font-weight: bold; fill: #059669;">
                USER REGISTRATION
            </text>
            
            <!-- Registration Form -->
            <rect x="50" y="90" width="500" height="180" class="box frontend"/>
            <text x="300" y="115" text-anchor="middle" class="title">Registration Form (Frontend)</text>
            <text x="70" y="145" class="code">const formData = {</text>
            <text x="90" y="165" class="code">name: "John Doe",</text>
            <text x="90" y="182" class="code">email: "john@example.com",</text>
            <text x="90" y="199" class="code">password: "secure123",</text>
            <text x="90" y="216" class="code">phone: "9876543210",</text>
            <text x="90" y="233" class="code">role: "SELLER"  // BUYER, SELLER, ADMIN</text>
            <text x="70" y="250" class="code">}</text>
            
            <!-- Arrow -->
            <line x1="300" y1="275" x2="300" y2="320" class="arrow"/>
            <text x="320" y="300" style="font-size: 12px; fill: #dc2626; font-weight: bold;">
                POST /api/auth/register
            </text>
            
            <!-- Backend Processing -->
            <rect x="50" y="330" width="500" height="220" class="box backend"/>
            <text x="300" y="355" text-anchor="middle" class="title">Spring Boot Backend</text>
            <text x="70" y="385" style="font-size: 12px; font-weight: bold;">1. Password Encryption (BCrypt)</text>
            <text x="90" y="405" class="code">String hashed = passwordEncoder.encode("secure123");</text>
            <text x="90" y="422" class="code">// Result: $2a$10$xyz...abc (60 chars)</text>
            <text x="70" y="450" style="font-size: 12px; font-weight: bold;">2. Create User Object</text>
            <text x="90" y="470" class="code">User user = new User();</text>
            <text x="90" y="487" class="code">user.setPassword(hashed);  // Store encrypted</text>
            <text x="70" y="515" style="font-size: 12px; font-weight: bold;">3. Save to Database</text>
            <text x="90" y="535" class="code">userRepository.save(user);</text>
            
            <!-- Arrow -->
            <line x1="300" y1="555" x2="300" y2="600" class="arrow-success"/>
            <text x="320" y="580" style="font-size: 12px; fill: #059669; font-weight: bold;">
                ‚úì Registration Success
            </text>
            
            <!-- Success Response -->
            <rect x="50" y="610" width="500" height="80" class="box success"/>
            <text x="300" y="635" text-anchor="middle" class="title">Response: User Object</text>
            <text x="70" y="660" class="code">{ userId: 15, name: "John Doe",</text>
            <text x="90" y="677" class="code">email: "john@example.com", role: "SELLER" }</text>
            
            
            <!-- ========== LOGIN FLOW ========== -->
            <text x="1150" y="70" text-anchor="middle" style="font-size: 18px; font-weight: bold; fill: #2563eb;">
                USER LOGIN
            </text>
            
            <!-- Login Form -->
            <rect x="900" y="90" width="500" height="120" class="box frontend"/>
            <text x="1150" y="115" text-anchor="middle" class="title">Login Form (Frontend)</text>
            <text x="920" y="145" class="code">const credentials = {</text>
            <text x="940" y="162" class="code">email: "john@example.com",</text>
            <text x="940" y="179" class="code">password: "secure123"</text>
            <text x="920" y="196" class="code">}</text>
            
            <!-- Arrow -->
            <line x1="1150" y1="215" x2="1150" y2="260" class="arrow"/>
            <text x="1170" y="240" style="font-size: 12px; fill: #dc2626; font-weight: bold;">
                POST /api/auth/login
            </text>
            
            <!-- Backend Validation -->
            <rect x="900" y="270" width="500" height="280" class="box backend"/>
            <text x="1150" y="295" text-anchor="middle" class="title">Spring Boot Backend</text>
            
            <text x="920" y="325" style="font-size: 12px; font-weight: bold;">1. Fetch User from Database</text>
            <text x="940" y="345" class="code">User user = userRepository.findByEmail(email);</text>
            
            <text x="920" y="375" style="font-size: 12px; font-weight: bold;">2. Validate Password (BCrypt)</text>
            <text x="940" y="395" class="code">boolean valid = passwordEncoder.matches(</text>
            <text x="960" y="412" class="code">"secure123",  // plaintext</text>
            <text x="960" y="429" class="code">user.getPassword()  // hashed from DB</text>
            <text x="940" y="446" class="code">);</text>
            
            <text x="920" y="476" style="font-size: 12px; font-weight: bold;">3. Generate JWT Token</text>
            <text x="940" y="496" class="code">String token = jwtUtil.generateToken(user);</text>
            <text x="960" y="513" class="code">// Subject: email</text>
            <text x="960" y="530" class="code">// Expiration: current time + 1 hour</text>
            
            <!-- Arrow -->
            <line x1="1150" y1="555" x2="1150" y2="600" class="arrow-success"/>
            <text x="1170" y="580" style="font-size: 12px; fill: #059669; font-weight: bold;">
                ‚úì Login Success
            </text>
            
            <!-- JWT Response -->
            <rect x="900" y="610" width="500" height="110" class="box success"/>
            <text x="1150" y="635" text-anchor="middle" class="title">Response: JWT Token + User</text>
            <text x="920" y="660" class="code">{</text>
            <text x="940" y="677" class="code">token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",</text>
            <text x="940" y="694" class="code">user: { userId: 15, email: "...", role: "SELLER" }</text>
            <text x="920" y="711" class="code">}</text>
            
            
            <!-- ========== CLIENT STORAGE ========== -->
            <text x="800" y="765" text-anchor="middle" style="font-size: 18px; font-weight: bold; fill: #7c3aed;">
                CLIENT-SIDE STORAGE
            </text>
            
            <rect x="500" y="785" width="600" height="100" class="box" style="fill: #f3e8ff;"/>
            <text x="800" y="810" text-anchor="middle" class="title">localStorage (Browser)</text>
            <text x="520" y="840" class="code">localStorage.setItem('token', "eyJhbGci...");</text>
            <text x="520" y="857" class="code">localStorage.setItem('user', JSON.stringify(userObject));</text>
            <text x="520" y="874" style="font-size: 11px; fill: #6b7280;">
                ‚ö†Ô∏è Token persists across browser sessions until logout
            </text>
            
            
            <!-- ========== AUTHENTICATED REQUESTS ========== -->
            <text x="800" y="935" text-anchor="middle" style="font-size: 18px; font-weight: bold; fill: #dc2626;">
                SUBSEQUENT AUTHENTICATED REQUESTS
            </text>
            
            <!-- API Request -->
            <rect x="50" y="960" width="500" height="120" class="box frontend"/>
            <text x="300" y="985" text-anchor="middle" class="title">Any API Request (Frontend)</text>
            <text x="70" y="1015" class="code">fetch('/api/properties', {</text>
            <text x="90" y="1032" class="code">headers: {</text>
            <text x="110" y="1049" class="code" style="fill: #dc2626;">'Authorization': 'Bearer eyJhbGci...'</text>
            <text x="90" y="1066" class="code">}</text>
            <text x="70" y="1073" class="code">})</text>
            
            <!-- Arrow -->
            <line x1="300" y1="1085" x2="300" y2="1130" class="arrow"/>
            
            <!-- JWT Filter -->
            <rect x="50" y="1140" width="500" height="220" class="box backend"/>
            <text x="300" y="1165" text-anchor="middle" class="title">JwtAuthenticationFilter</text>
            <text x="70" y="1195" style="font-size: 12px; font-weight: bold;">1. Extract Token from Header</text>
            <text x="90" y="1215" class="code">String token = header.substring(7); // Remove "Bearer "</text>
            
            <text x="70" y="1245" style="font-size: 12px; font-weight: bold;">2. Validate Token</text>
            <text x="90" y="1265" class="code">‚Ä¢ Check expiration (< 1 hour old)</text>
            <text x="90" y="1282" class="code">‚Ä¢ Verify HMAC signature</text>
            <text x="90" y="1299" class="code">‚Ä¢ Extract username (email)</text>
            
            <text x="70" y="1329" style="font-size: 12px; font-weight: bold;">3. Load User & Set Authentication</text>
            <text x="90" y="1349" class="code">SecurityContextHolder.setAuthentication(auth);</text>
            
            <!-- Authorization Check -->
            <rect x="900" y="960" width="500" height="180" class="box" style="fill: #fef3c7;"/>
            <text x="1150" y="985" text-anchor="middle" class="title">@PreAuthorize Annotations</text>
            <text x="920" y="1015" class="code">@PreAuthorize("hasRole('ADMIN')")</text>
            <text x="920" y="1032" class="code">public ResponseEntity adminOnly() { ... }</text>
            
            <text x="920" y="1067" class="code">@PreAuthorize("hasRole('SELLER')")</text>
            <text x="920" y="1084" class="code">public ResponseEntity sellerOnly() { ... }</text>
            
            <text x="920" y="1119" class="code">@PreAuthorize("hasRole('BUYER')")</text>
            <text x="920" y="1136" class="code">public ResponseEntity buyerOnly() { ... }</text>
            
            <!-- Decision -->
            <rect x="900" y="1160" width="230" height="70" class="box success"/>
            <text x="1015" y="1185" text-anchor="middle" class="title" style="fill: #059669;">‚úì ALLOWED</text>
            <text x="920" y="1215" style="font-size: 11px;">Execute controller method</text>
            
            <rect x="1170" y="1160" width="230" height="70" class="box error"/>
            <text x="1285" y="1185" text-anchor="middle" class="title" style="fill: #dc2626;">‚úó DENIED</text>
            <text x="1190" y="1215" style="font-size: 11px;">HTTP 403 Forbidden</text>
            
            <!-- Arrows from filter -->
            <line x1="550" y1="1250" x2="900" y2="1195" class="arrow-success"/>
            <line x1="550" y1="1250" x2="1170" y2="1195" class="arrow-error"/>
            
            <!-- JWT Token Structure -->
            <rect x="50" y="1310" width="1350" height="80" class="box" style="fill: #e0e7ff;"/>
            <text x="725" y="1335" text-anchor="middle" class="title">JWT Token Structure (3 Parts)</text>
            <text x="70" y="1365" class="code" style="fill: #dc2626;">Header:</text>
            <text x="160" y="1365" class="code">{ "alg": "HS256", "typ": "JWT" }</text>
            <text x="450" y="1365" class="code" style="fill: #dc2626;">Payload:</text>
            <text x="540" y="1365" class="code">{ "sub": "john@example.com", "iat": 1234567890, "exp": 1234571490 }</text>
            <text x="1150" y="1365" class="code" style="fill: #dc2626;">Signature:</text>
            <text x="1240" y="1365" class="code">HMAC-SHA256(header+payload, SECRET_KEY)</text>
        </svg>
    </div>
</body>
</html>
